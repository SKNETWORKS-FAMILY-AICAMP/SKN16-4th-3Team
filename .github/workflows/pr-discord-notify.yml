name: PR Discord Notify

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  discord-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Debug Environment Variables
        run: |
          echo "GITHUB_ACTOR: ${{ github.actor }}"
          echo "PR_TITLE: ${{ github.event.pull_request.title }}"
          echo "PR_URL: ${{ github.event.pull_request.html_url }}"
          echo "Webhook URL exists: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}"
          
      - name: Send PR info to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_ACTOR: ${{ github.actor }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_REVIEWERS: ${{ join(github.event.pull_request.requested_reviewers.*.login, ', ') }}
        run: |
          # Discord Webhook URL ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "âŒ DISCORD_WEBHOOK_URL secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… Discord Webhook URLì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          
          # JSON payload ì¤€ë¹„
          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "ğŸ”” New Pull Request",
              "description": "**${PR_TITLE}**",
              "url": "${PR_URL}",
              "color": 3447003,
              "fields": [
                {
                  "name": "ğŸ¤– Author",
                  "value": "${GITHUB_ACTOR}",
                  "inline": true
                },
                {
                  "name": "ğŸ” Reviewers",
                  "value": "${PR_REVIEWERS:-'No reviewers assigned'}",
                  "inline": true
                }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )
          
          # Discord webhook í˜¸ì¶œ
          response=$(curl -s -w "%{http_code}" -o /tmp/discord_response.json \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK")
          
          echo "HTTP Status Code: $response"
          if [ "$response" != "204" ]; then
            echo "Discord API Response:"
            cat /tmp/discord_response.json
            exit 1
          else
            echo "Successfully sent Discord notification!"
          fi
